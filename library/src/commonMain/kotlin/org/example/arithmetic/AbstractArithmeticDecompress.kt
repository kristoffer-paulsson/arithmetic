/**
 * Reference arithmetic coding
 *
 * Copyright (c) 2025 by Kristoffer Paulsson <kristoffer.paulsson@talenten.se>.
 *
 * Copyright (c) Project Nayuki
 * https://www.nayuki.io/page/reference-arithmetic-coding
 *
 * This software is available under the terms of the MIT license.
 * The legal terms are attached to the LICENSE file and are made
 * available on:
 *
 *      https://opensource.org/licenses/MIT
 *
 * SPDX-License-Identifier: MIT
 *
 * Contributors:
 *      Nayuki - initial Java implementation
 *      Kristoffer Paulsson - porting and adaption to Kotlin for alternative use
 */
package org.example.arithmetic

import org.example.arithmetic.io.BitInput
import org.example.arithmetic.io.ByteOutput

/**
 * Decompression application using static arithmetic coding.
 *
 * Usage: java ArithmeticDecompress InputFile OutputFile
 *
 * This decompresses files generated by the "ArithmeticCompress" application.
 */
public abstract class AbstractArithmeticDecompress {

    // To allow unit testing, this method is package-private instead of private.
    public fun readFrequencies(inp: BitInput): FrequencyTable {
        val freqs = IntArray(257)
        //for (i in 0..255) freqs[i] = readInt(inp, 32)
        repeat(256) { freqs[it] = readInt(inp, 32) }
        freqs[256] = 1 // EOF symbol
        return SimpleFrequencyTable(freqs)
    }

    // To allow unit testing, this method is package-private instead of private.
    public fun decompress(freqs: FrequencyTable, inp: BitInput, out: ByteOutput) {
        val dec = ArithmeticDecoder(32, inp)
        while (true) {
            val symbol: Int = dec.read(freqs)
            if (symbol == 256)  // EOF symbol
                break
            out.write(symbol)
        }
    }

    // Reads an unsigned integer of the given bit width from the given stream.
    private fun readInt(inp: BitInput, numBits: Int): Int {
        require(numBits in 0..32)

        var result = 0
        repeat(numBits) { result = (result shl 1) or inp.readNoEof() }
        //for (i in 0..<numBits) result = (result shl 1) or inp.readNoEof() // Big endian

        return result
    }
}
